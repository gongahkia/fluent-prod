name: Update Reddit Cache (NDJSON)

on:
  workflow_dispatch:
    inputs:
      cache_preset:
        description: "Cache preset to generate"
        required: false
        default: "showcase"
        type: choice
        options:
          - showcase
      target_lang:
        description: "Target language (e.g. ja)"
        required: false
        default: "ja"
        type: string
      max_new_posts:
        description: "Max new posts to fetch"
        required: false
        default: "200"
        type: string


permissions:
  contents: write

jobs:
  update-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend deps
        run: npm ci --prefix backend

      - name: Generate cache
        env:
          CACHE_PRESET: ${{ inputs.cache_preset || 'showcase' }}
          TARGET_LANG: ${{ inputs.target_lang || 'ja' }}
          MAX_NEW_POSTS: ${{ inputs.max_new_posts || '200' }}
          OUT_FILE: news-cache.txt
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID || '' }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET || '' }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT || '' }}
        run: node backend/seed-showcase-posts.js

      - name: Commit cache changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cache/news-cache.txt
          git diff --staged --quiet || git commit -m "chore(cache): update reddit cache"
          git push
