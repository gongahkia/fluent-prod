generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                @id @default(uuid())
  email               String                @unique
  name                String
  bio                 String?
  location            String?
  website             String?
  profilePictureUrl   String?
  bannerImage         String?
  targetLanguage      String?
  nativeLanguages     String[]
  level               Int?
  onboardingCompleted Boolean               @default(false)
  completedAt         DateTime?
  followersCount      Int                   @default(0)
  followingCount      Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  collections         Collection[]
  dictionaryWords     DictionaryWord[]
  encryptedCreds      EncryptedCredentials?
  flashcards          Flashcard[]
  savedPosts          SavedPost[]
  blockedBy           UserBlock[]           @relation("UserBlockedBy")
  blocking            UserBlock[]           @relation("UserBlocking")
  following           UserFollow[]          @relation("UserFollowing")
  followers           UserFollow[]          @relation("UserFollowers")
  settings            UserSettings?

  @@index([email])
  @@index([targetLanguage])
  @@map("users")
}

model UserSettings {
  id                   String   @id @default(uuid())
  userId               String   @unique
  emailNotifications   Boolean  @default(true)
  pushNotifications    Boolean  @default(true)
  commentNotifications Boolean  @default(true)
  profileVisibility    String   @default("public")
  showEmail            Boolean  @default(false)
  showLocation         Boolean  @default(true)
  theme                String   @default("light")
  accentColor          String   @default("orange")
  fontSize             String   @default("medium")
  dailyWords           Int      @default(10)
  dailyReading         Int      @default(5)
  studyReminder        Boolean  @default(true)
  reminderTime         String   @default("18:00")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model EncryptedCredentials {
  id            String   @id @default(uuid())
  userId        String   @unique
  encryptedData String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("encrypted_credentials")
}

model DictionaryWord {
  id              String           @id @default(uuid())
  userId          String
  language        String
  word            String
  english         String
  japanese        String?
  hiragana        String?
  kanji           String?
  romaji          String?
  korean          String?
  romanization    String?
  pronunciation   String?
  hanja           String?
  meaning         String?
  partOfSpeech    String?
  level           Int?
  jlptLevel       String?
  topikLevel      String?
  examples        Json?
  example         String?
  exampleEn       String?
  source          String?
  dateAdded       DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  collectionWords CollectionWord[]
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcard       Flashcard?

  @@unique([userId, word, language])
  @@index([userId, language])
  @@index([language])
  @@index([level])
  @@index([userId, language], map: "idx_dictionary_words_user_lang")
  @@map("dictionary_words")
}

model Flashcard {
  id             String         @id @default(uuid())
  userId         String
  wordId         String         @unique
  interval       Int            @default(1)
  repetitions    Int            @default(0)
  easeFactor     Float          @default(2.5)
  lastReviewed   DateTime?
  nextReview     DateTime?
  correctCount   Int            @default(0)
  incorrectCount Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  word           DictionaryWord @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([nextReview])
  @@map("flashcards")
}

model Collection {
  id              String           @id @default(uuid())
  userId          String
  name            String
  description     String?
  isDefault       Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  collectionWords CollectionWord[]
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
  @@index([userId, isDefault], map: "idx_collections_user_default")
  @@map("collections")
}

model CollectionWord {
  id           String         @id @default(uuid())
  collectionId String
  wordId       String
  addedAt      DateTime       @default(now())
  collection   Collection     @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  word         DictionaryWord @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([collectionId, wordId])
  @@index([collectionId])
  @@index([wordId])
  @@map("collection_words")
}

model SavedPost {
  id          String   @id @default(uuid())
  userId      String
  postId      String
  title       String
  content     String
  url         String
  author      String
  publishedAt DateTime
  source      String   @default("reddit")
  tags        String[]
  difficulty  Int?
  savedAt     DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([difficulty])
  @@index([userId, savedAt(sort: Desc)], map: "idx_saved_posts_user_saved")
  @@map("saved_posts")
}

model UserFollow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  followedAt  DateTime @default(now())
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([followerId], map: "idx_user_follows_follower")
  @@index([followingId], map: "idx_user_follows_following")
  @@map("user_follows")
}

model UserBlock {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  blockedAt DateTime @default(now())
  blocked   User     @relation("UserBlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)
  blocker   User     @relation("UserBlocking", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("user_blocks")
}

model NewsCache {
  id                String   @id @default(uuid())
  cacheKey          String
  postId            String
  title             String
  content           String
  url               String
  author            String
  publishedAt       DateTime
  source            String   @default("reddit")
  tags              String[]
  difficulty        Int?
  targetLang        String
  translatedTitle   Json?
  translatedContent Json?
  originalTitle     String?
  originalContent   String?
  fetchedAt         DateTime @default(now())
  lastUpdated       DateTime @updatedAt
  version           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([cacheKey, postId])
  @@index([cacheKey])
  @@index([difficulty])
  @@index([targetLang])
  @@index([cacheKey, fetchedAt(sort: Desc)], map: "idx_news_cache_key_fetched")
  @@map("news_cache")
}
