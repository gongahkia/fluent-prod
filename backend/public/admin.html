<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fluent Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: #1e293b;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    h1 {
      font-size: 28px;
      color: #60a5fa;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 14px;
    }

    .search-section {
      background: #1e293b;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    input[type="text"], input[type="email"], input[type="number"], textarea, select {
      flex: 1;
      padding: 12px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #60a5fa;
    }

    button {
      padding: 12px 24px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background: #2563eb;
    }

    button.danger {
      background: #ef4444;
    }

    button.danger:hover {
      background: #dc2626;
    }

    button.secondary {
      background: #64748b;
    }

    button.secondary:hover {
      background: #475569;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px 20px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    .content-section {
      background: #1e293b;
      padding: 20px;
      border-radius: 8px;
      min-height: 400px;
    }

    .users-grid {
      display: grid;
      gap: 15px;
    }

    .user-card {
      background: #0f172a;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #334155;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-card:hover {
      border-color: #60a5fa;
      transform: translateY(-2px);
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .user-name {
      font-weight: 600;
      color: #60a5fa;
      font-size: 16px;
    }

    .user-email {
      color: #94a3b8;
      font-size: 14px;
    }

    .user-stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      font-size: 12px;
      color: #94a3b8;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: #1e293b;
      padding: 30px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 24px;
      color: #60a5fa;
    }

    .close-btn {
      background: none;
      color: #94a3b8;
      font-size: 24px;
      padding: 0;
      width: 30px;
      height: 30px;
      cursor: pointer;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #cbd5e1;
      font-size: 14px;
      font-weight: 500;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #334155;
    }

    .data-table th {
      background: #0f172a;
      color: #60a5fa;
      font-weight: 600;
    }

    .data-table tr:hover {
      background: #0f172a;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge.success {
      background: #10b981;
      color: white;
    }

    .badge.warning {
      background: #f59e0b;
      color: white;
    }

    .badge.info {
      background: #3b82f6;
      color: white;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
    }

    .error {
      background: #7f1d1d;
      color: #fca5a5;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .success {
      background: #064e3b;
      color: #6ee7b7;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .small-btn {
      padding: 6px 12px;
      font-size: 12px;
    }

    .json-view {
      background: #0f172a;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #334155;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    textarea {
      min-height: 100px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ”’ Fluent Admin Dashboard</h1>
      <p class="subtitle">Firebase Database Management</p>
    </header>

    <div class="search-section">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search users by name or email...">
        <button onclick="searchUsers()">Search</button>
        <button class="secondary" onclick="loadAllUsers()">Load All Users</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">Users</div>
      <div class="tab" onclick="switchTab('dictionary')">Dictionary</div>
      <div class="tab" onclick="switchTab('flashcards')">Flashcards</div>
      <div class="tab" onclick="switchTab('savedPosts')">Saved Posts</div>
      <div class="tab" onclick="switchTab('collections')">Collections</div>
      <div class="tab" onclick="switchTab('social')">Social</div>
    </div>

    <div class="content-section" id="contentSection">
      <div class="loading">Select a user to view their data</div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">User Details</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    let currentTab = 'users';
    let currentUser = null;
    let allUsers = [];

    // Authentication check
    function checkAuth() {
      const credentials = sessionStorage.getItem('adminAuth');
      if (!credentials) {
        const username = prompt('Admin Username:');
        const password = prompt('Admin Password:');
        if (username && password) {
          const encoded = btoa(`${username}:${password}`);
          sessionStorage.setItem('adminAuth', encoded);
        }
      }
    }

    function getAuthHeader() {
      const encoded = sessionStorage.getItem('adminAuth');
      return { 'Authorization': `Basic ${encoded}` };
    }

    async function apiRequest(url, options = {}) {
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            ...getAuthHeader(),
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        if (response.status === 401) {
          sessionStorage.removeItem('adminAuth');
          alert('Authentication failed. Please refresh the page and try again.');
          return null;
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('API Error:', error);
        alert('Error: ' + error.message);
        return null;
      }
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      if (currentUser) {
        loadUserData(currentUser);
      } else {
        document.getElementById('contentSection').innerHTML = '<div class="loading">Select a user to view their data</div>';
      }
    }

    async function loadAllUsers() {
      document.getElementById('contentSection').innerHTML = '<div class="loading">Loading users...</div>';

      const response = await apiRequest(`${API_BASE}/users`);
      if (response && response.success) {
        allUsers = response.data;
        displayUsers(allUsers);
      }
    }

    async function searchUsers() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        alert('Please enter a search query');
        return;
      }

      document.getElementById('contentSection').innerHTML = '<div class="loading">Searching...</div>';

      const response = await apiRequest(`${API_BASE}/users/search?q=${encodeURIComponent(query)}`);
      if (response && response.success) {
        allUsers = response.data;
        displayUsers(allUsers);
      }
    }

    function displayUsers(users) {
      if (users.length === 0) {
        document.getElementById('contentSection').innerHTML = '<div class="loading">No users found</div>';
        return;
      }

      const html = `
        <h3 style="margin-bottom: 15px; color: #60a5fa;">Found ${users.length} user(s)</h3>
        <div class="users-grid">
          ${users.map(user => `
            <div class="user-card" onclick="selectUser('${user.id}')">
              <div class="user-header">
                <div>
                  <div class="user-name">${user.name || 'No Name'}</div>
                  <div class="user-email">${user.email || 'No Email'}</div>
                </div>
                <span class="badge info">Level ${user.level || 1}</span>
              </div>
              <div class="user-stats">
                <span>ðŸ“š Target: ${user.targetLanguage || 'N/A'}</span>
                <span>ðŸ‘¥ Followers: ${user.followersCount || 0}</span>
                <span>ðŸ“– Following: ${user.followingCount || 0}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('contentSection').innerHTML = html;
    }

    async function selectUser(userId) {
      currentUser = userId;
      loadUserData(userId);
    }

    async function loadUserData(userId) {
      const contentSection = document.getElementById('contentSection');
      contentSection.innerHTML = '<div class="loading">Loading data...</div>';

      switch (currentTab) {
        case 'users':
          await loadUserProfile(userId);
          break;
        case 'dictionary':
          await loadDictionary(userId);
          break;
        case 'flashcards':
          await loadFlashcards(userId);
          break;
        case 'savedPosts':
          await loadSavedPosts(userId);
          break;
        case 'collections':
          await loadCollections(userId);
          break;
        case 'social':
          await loadSocialConnections(userId);
          break;
      }
    }

    async function loadUserProfile(userId) {
      const response = await apiRequest(`${API_BASE}/users/${userId}`);
      if (response && response.success) {
        const user = response.data;
        const html = `
          <h3 style="margin-bottom: 20px; color: #60a5fa;">User Profile</h3>
          <div class="json-view">${JSON.stringify(user, null, 2)}</div>
          <div class="form-actions">
            <button onclick="editUser('${userId}')">Edit User</button>
            <button class="danger" onclick="deleteUser('${userId}')">Delete User</button>
          </div>
        `;
        document.getElementById('contentSection').innerHTML = html;
      }
    }

    async function loadDictionary(userId) {
      const [jaResponse, koResponse] = await Promise.all([
        apiRequest(`${API_BASE}/users/${userId}/dictionary/ja`),
        apiRequest(`${API_BASE}/users/${userId}/dictionary/ko`)
      ]);

      const jaEntries = jaResponse?.success ? jaResponse.data : [];
      const koEntries = koResponse?.success ? koResponse.data : [];

      const html = `
        <h3 style="margin-bottom: 20px; color: #60a5fa;">Dictionary Entries</h3>
        <div style="margin-bottom: 20px;">
          <button onclick="addDictionaryEntry('${userId}', 'ja')">Add Japanese Entry</button>
          <button onclick="addDictionaryEntry('${userId}', 'ko')">Add Korean Entry</button>
        </div>
        <h4 style="color: #94a3b8; margin: 20px 0 10px 0;">Japanese (${jaEntries.length})</h4>
        ${renderDictionaryTable(userId, 'ja', jaEntries)}
        <h4 style="color: #94a3b8; margin: 20px 0 10px 0;">Korean (${koEntries.length})</h4>
        ${renderDictionaryTable(userId, 'ko', koEntries)}
      `;

      document.getElementById('contentSection').innerHTML = html;
    }

    function renderDictionaryTable(userId, lang, entries) {
      if (entries.length === 0) return '<p style="color: #64748b;">No entries found</p>';

      const isJapanese = lang === 'ja';
      return `
        <table class="data-table">
          <thead>
            <tr>
              <th>English</th>
              <th>${isJapanese ? 'Japanese' : 'Korean'}</th>
              <th>${isJapanese ? 'Hiragana' : 'Romanization'}</th>
              <th>Level</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${entries.map(entry => `
              <tr>
                <td>${entry.english || 'N/A'}</td>
                <td>${entry[isJapanese ? 'japanese' : 'korean'] || 'N/A'}</td>
                <td>${entry[isJapanese ? 'hiragana' : 'romanization'] || 'N/A'}</td>
                <td><span class="badge info">L${entry.level || 1}</span></td>
                <td class="action-buttons">
                  <button class="small-btn" onclick="editDictionaryEntry('${userId}', '${lang}', '${entry.id}')">Edit</button>
                  <button class="small-btn danger" onclick="deleteDictionaryEntry('${userId}', '${lang}', '${entry.id}')">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function loadFlashcards(userId) {
      const response = await apiRequest(`${API_BASE}/users/${userId}/flashcards`);
      if (response && response.success) {
        const flashcards = response.data;
        const html = `
          <h3 style="margin-bottom: 20px; color: #60a5fa;">Flashcards (${flashcards.length})</h3>
          ${flashcards.length === 0 ? '<p style="color: #64748b;">No flashcards found</p>' : `
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Correct</th>
                  <th>Incorrect</th>
                  <th>Proficiency</th>
                  <th>Last Reviewed</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${flashcards.map(card => `
                  <tr>
                    <td>${card.id}</td>
                    <td>${card.correctCount || 0}</td>
                    <td>${card.incorrectCount || 0}</td>
                    <td><span class="badge ${card.proficiency >= 70 ? 'success' : 'warning'}">${card.proficiency || 0}%</span></td>
                    <td>${card.lastReviewed ? new Date(card.lastReviewed.seconds * 1000).toLocaleDateString() : 'Never'}</td>
                    <td class="action-buttons">
                      <button class="small-btn danger" onclick="deleteFlashcard('${userId}', '${card.id}')">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `}
        `;
        document.getElementById('contentSection').innerHTML = html;
      }
    }

    async function loadSavedPosts(userId) {
      const response = await apiRequest(`${API_BASE}/users/${userId}/saved-posts`);
      if (response && response.success) {
        const posts = response.data;
        const html = `
          <h3 style="margin-bottom: 20px; color: #60a5fa;">Saved Posts (${posts.length})</h3>
          ${posts.length === 0 ? '<p style="color: #64748b;">No saved posts found</p>' : `
            <div style="display: grid; gap: 15px;">
              ${posts.map(post => `
                <div style="background: #0f172a; padding: 15px; border-radius: 6px; border: 1px solid #334155;">
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                      <h4 style="color: #60a5fa; margin-bottom: 10px;">${post.title || 'No Title'}</h4>
                      <p style="color: #94a3b8; font-size: 14px; margin-bottom: 10px;">${(post.content || '').substring(0, 200)}...</p>
                      <span class="badge info">${post.source || 'Unknown'}</span>
                    </div>
                    <button class="small-btn danger" onclick="deleteSavedPost('${userId}', '${post.id}')">Delete</button>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        `;
        document.getElementById('contentSection').innerHTML = html;
      }
    }

    async function loadCollections(userId) {
      const response = await apiRequest(`${API_BASE}/users/${userId}/collections`);
      if (response && response.success) {
        const collections = response.data;
        const html = `
          <h3 style="margin-bottom: 20px; color: #60a5fa;">Collections (${collections.length})</h3>
          ${collections.length === 0 ? '<p style="color: #64748b;">No collections found</p>' : `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Word Count</th>
                  <th>Default</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${collections.map(col => `
                  <tr>
                    <td>${col.name || 'Unnamed'}</td>
                    <td>${col.description || 'No description'}</td>
                    <td>${col.wordIds?.length || 0}</td>
                    <td>${col.isDefault ? '<span class="badge success">Yes</span>' : ''}</td>
                    <td class="action-buttons">
                      <button class="small-btn danger" onclick="deleteCollection('${userId}', '${col.id}')">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `}
        `;
        document.getElementById('contentSection').innerHTML = html;
      }
    }

    async function loadSocialConnections(userId) {
      const response = await apiRequest(`${API_BASE}/users/${userId}/social`);
      if (response && response.success) {
        const { following, followers, blocked } = response.data;
        const html = `
          <h3 style="margin-bottom: 20px; color: #60a5fa;">Social Connections</h3>
          <div style="display: grid; gap: 20px;">
            <div>
              <h4 style="color: #94a3b8; margin-bottom: 10px;">Following (${following.length})</h4>
              <div class="json-view">${JSON.stringify(following, null, 2)}</div>
            </div>
            <div>
              <h4 style="color: #94a3b8; margin-bottom: 10px;">Followers (${followers.length})</h4>
              <div class="json-view">${JSON.stringify(followers, null, 2)}</div>
            </div>
            <div>
              <h4 style="color: #94a3b8; margin-bottom: 10px;">Blocked (${blocked.length})</h4>
              <div class="json-view">${JSON.stringify(blocked, null, 2)}</div>
            </div>
          </div>
        `;
        document.getElementById('contentSection').innerHTML = html;
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user and ALL their data? This cannot be undone!')) {
        return;
      }

      const response = await apiRequest(`${API_BASE}/users/${userId}`, { method: 'DELETE' });
      if (response && response.success) {
        alert('User deleted successfully');
        currentUser = null;
        loadAllUsers();
      }
    }

    async function deleteDictionaryEntry(userId, lang, entryId) {
      if (!confirm('Delete this dictionary entry?')) return;

      const response = await apiRequest(`${API_BASE}/users/${userId}/dictionary/${lang}/${entryId}`, { method: 'DELETE' });
      if (response && response.success) {
        alert('Entry deleted');
        loadDictionary(userId);
      }
    }

    async function deleteFlashcard(userId, flashcardId) {
      if (!confirm('Delete this flashcard?')) return;

      const response = await apiRequest(`${API_BASE}/users/${userId}/flashcards/${flashcardId}`, { method: 'DELETE' });
      if (response && response.success) {
        alert('Flashcard deleted');
        loadFlashcards(userId);
      }
    }

    async function deleteSavedPost(userId, postId) {
      if (!confirm('Delete this saved post?')) return;

      const response = await apiRequest(`${API_BASE}/users/${userId}/saved-posts/${postId}`, { method: 'DELETE' });
      if (response && response.success) {
        alert('Post deleted');
        loadSavedPosts(userId);
      }
    }

    async function deleteCollection(userId, collectionId) {
      if (!confirm('Delete this collection?')) return;

      const response = await apiRequest(`${API_BASE}/users/${userId}/collections/${collectionId}`, { method: 'DELETE' });
      if (response && response.success) {
        alert('Collection deleted');
        loadCollections(userId);
      }
    }

    function editUser(userId) {
      alert('User editing modal - To be implemented. For now, use the JSON view to see all fields.');
    }

    function addDictionaryEntry(userId, lang) {
      alert('Add dictionary entry modal - To be implemented.');
    }

    function editDictionaryEntry(userId, lang, entryId) {
      alert('Edit dictionary entry modal - To be implemented.');
    }

    function closeModal() {
      document.getElementById('userModal').classList.remove('active');
    }

    // Initialize
    checkAuth();
    loadAllUsers();

    // Allow Enter key in search
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchUsers();
    });
  </script>
</body>
</html>
